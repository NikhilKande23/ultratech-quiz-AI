<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraTech GENIUS BATTLE - Team Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #95a5a6 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .logo-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-img {
            height: 60px;
        }

        .container {
            max-width: 1000px;
            margin: 80px auto 0; /* Margin top for logos */
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            background: rgba(0,0,0,0.1);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .team-info {
            background: linear-gradient(45deg, #f1c40f, #f39c12);
            color: #2c3e50;
            padding: 15px 30px;
            border-radius: 15px;
            display: inline-block;
            font-weight: bold;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #f1c40f, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .quiz-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .round-indicator {
            text-align: center;
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            padding: 15px 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
        }

        .question-info {
            text-align: center;
        }

        .question-counter {
            font-size: 1.4rem;
            color: #f1c40f;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .score-display {
            font-size: 1.2rem;
            color: #2ecc71;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .score-display.updated {
            transform: scale(1.2);
            color: #f1c40f;
        }

        .timer-display {
            font-size: 2.5rem;
            color: #f1c40f;
            font-weight: bold;
            background: rgba(0,0,0,0.3);
            padding: 15px 25px;
            border-radius: 15px;
            position: relative;
        }

        .timer-display::after {
            content: "üåê";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.8rem;
            opacity: 0.7;
            title: "Synced with server";
        }

        .timer-display.warning {
            color: #e74c3c;
            animation: pulse 1s infinite;
        }

        .timer-display.stopped {
            color: #7f8c8d;
            opacity: 0.6;
        }

        .timer-display.stopped::after {
            content: "‚è∏Ô∏è";
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .question-card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #f1c40f;
            transition: all 0.5s ease;
            animation: slideIn 0.5s ease;
            opacity: 1;
        }

        /* Fade Animation Classes */
        .question-card.fade-out {
            opacity: 0;
            transform: translateX(-30px);
            transition: all 0.3s ease;
        }

        .question-card.fade-in {
            opacity: 1;
            transform: translateX(0);
            animation: fadeInSlide 0.3s ease;
        }

        @keyframes fadeInSlide {
            from { 
                opacity: 0; 
                transform: translateX(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(50px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        .question-difficulty {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .difficulty-simple {
            background: #27ae60;
            color: white;
        }

        .difficulty-scenario {
            background: #3498db;
            color: white;
        }

        .question-text {
            font-size: 1.4rem;
            margin-bottom: 20px;
            line-height: 1.6;
            text-align: center;
        }

        .scenario-text {
            background: rgba(52, 152, 219, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            font-style: italic;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .option-btn {
            background: rgba(255,255,255,0.1);
            border: 3px solid rgba(255,255,255,0.3);
            padding: 15px;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option-btn:hover:not(.disabled) {
            background: rgba(255,255,255,0.2);
            border-color: #f1c40f;
            transform: translateY(-2px);
        }

        .option-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .option-btn.correct {
            background: #27ae60;
            border-color: #2ecc71;
            animation: celebrate 1s ease;
        }

        .option-btn.wrong {
            background: #e74c3c;
            border-color: #c0392b;
            animation: shake 0.5s ease;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(-2deg); }
            75% { transform: scale(1.05) rotate(2deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .waiting-screen {
            text-align: center;
            padding: 60px 40px;
            background: rgba(52,152,219,0.2);
            border-radius: 20px;
            border: 2px solid #3498db;
        }

        .completion-screen {
            text-align: center;
            padding: 40px;
            background: rgba(39,174,96,0.2);
            border-radius: 20px;
            border: 2px solid #27ae60;
        }

        .final-score {
            font-size: 3rem;
            color: #f1c40f;
            font-weight: bold;
            margin: 20px 0;
        }

        .prompt-input {
            width: 100%;
            min-height: 120px;
            background: rgba(255,255,255,0.1);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: white;
            padding: 15px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            margin: 15px 0;
        }

        .prompt-input:focus {
            outline: none;
            border-color: #f1c40f;
            box-shadow: 0 0 15px rgba(241,196,15,0.3);
        }

        .prompt-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .submit-prompt-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-prompt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .submit-prompt-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            color: #f1c40f;
            margin: 20px 0;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .connected {
            background: #27ae60;
            color: white;
        }

        .disconnected {
            background: #e74c3c;
            color: white;
        }

        .session-expired {
            text-align: center;
            padding: 60px 40px;
            background: rgba(231,76,60,0.2);
            border-radius: 20px;
            border: 2px solid #e74c3c;
        }

        .session-expired h2 {
            color: #e74c3c;
            margin-bottom: 20px;
        }

        .waiting-for-timer {
            text-align: center;
            background: rgba(241,196,15,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #f1c40f;
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="aditya-birla-logo copy.png" alt="Aditya Birla Logo" class="logo-img">
        <img src="dit-logo.png" alt="DIT Logo" class="logo-img">
    </div>
    <div class="connection-status" id="connectionStatus">üîÑ Connecting...</div>
    
    <div class="container">
        <header class="header">
            <div class="team-info" id="teamInfo">Loading Team...</div>
            <h1>üß† GENIUS BATTLE üß†</h1>
            <p>UltraTech Quiz Challenge</p>
        </header>

        <div class="quiz-container" id="quizContainer">
            <div class="loading">üîÑ Loading quiz system...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBXA54F8OQvEo5RZzokUIBFT5pOUlQk-TQ",
            authDomain: "ultratech-quiz-ai.firebaseapp.com",
            projectId: "ultratech-quiz-ai",
            storageBucket: "ultratech-quiz-ai.firebasestorage.app",
            messagingSenderId: "846386736581",
            appId: "1:846386736581:web:91446988c0fc8597f92fac"
        };

        // Team Data
        const teamData = {
            1: {name: "Team RAM", fullName: "Rapid Action Minds"},
            2: {name: "Team GB", fullName: "Giggle Bytes"},
            3: {name: "Team WiFi", fullName: "We're fun inside"},
            4: {name: "Team AI", fullName: "Accelerated Innovators"},
            5: {name: "Team IP", fullName: "Infinite Pings"},
            6: {name: "Team WAF", fullName: "We are Fabulous"},
            7: {name: "Team TAG", fullName: "Think, Act, Grow"},
            8: {name: "Team SSO", fullName: "Smart Solutions only"},
            9: {name: "Team TB", fullName: "Tech Brigade"},
            10: {name: "Team MB", fullName: "Mega Buddies"}
        };

        // Game state
        let teamId = null;
        let currentRound = 0;
        let currentQuestionIndex = 0;
        let currentScore = 0;
        let timer = null;
        let timeLeft = 0;
        let roundEndTime = null; // Authoritative end time from server
        let currentPromptTask = 0;
        let roundActive = false;
        let db = null;
        let gameStateListener = null;

        // Question Banks
        const round1Questions = [
            {
                question: "What is the main benefit of AI-powered predictive maintenance in manufacturing?",
                options: ["Reduces labor costs", "Eliminates all failures", "Increases production speed", "Reduces material waste", "Prevents breakdowns early", "Automates quality control"],
                correct: [4],
                difficulty: "simple",
                points: 3
            },
            {
                question: "When a system understands and responds to human language queries, this represents which AI capability?",
                options: ["Natural Language Processing", "Computer Vision Analytics", "Robotic Process Automation", "Predictive Analytics Modeling", "Machine Learning Algorithms", "Deep Learning Networks"],
                correct: [0],
                difficulty: "simple",
                points: 3
            },
            {
                question: "Expert control systems in manufacturing primarily optimize which aspect?",
                options: ["Employee scheduling", "Transportation routes", "Customer management", "Process operations", "Financial reporting", "Inventory tracking"],
                correct: [3],
                difficulty: "simple",
                points: 3
            },
            {
                question: "Machine Learning algorithms in quality control primarily help with which function?",
                options: ["Production scheduling", "Employee training", "Equipment maintenance", "Energy monitoring", "Pattern recognition", "Inventory management"],
                correct: [4],
                difficulty: "simple",
                points: 3
            },
            {
                question: "What distinguishes Agentic AI from traditional chatbots in business applications?",
                options: ["Uses larger datasets", "Requires less computing", "Takes autonomous actions", "Processes text faster", "Costs less to implement", "Needs human oversight"],
                correct: [2],
                difficulty: "simple",
                points: 3
            },
            {
                question: "In machine learning, what does 'training data' primarily determine?",
                options: ["Processing speed", "Model accuracy", "Storage requirements", "User interface design", "Network connectivity", "Hardware specifications"],
                correct: [1],
                difficulty: "simple",
                points: 3
            },
            {
                question: "A cement plant AI system saves 1.90 lakh litres of fuel annually through equipment monitoring. This demonstrates which AI application category?",
                options: ["Customer analytics", "Operational optimization", "Financial forecasting", "Supply chain planning", "Quality assurance", "Safety monitoring"],
                correct: [1],
                difficulty: "simple",
                points: 3
            },
            {
                question: "When multiple AI systems work together - one detecting issues, another scheduling repairs, and a third optimizing operations - this represents which concept?",
                options: ["Multi-agent orchestration", "Supervised learning", "Neural network processing", "Reinforcement learning", "Data pipeline automation", "Cloud computing integration"],
                correct: [0],
                difficulty: "simple",
                points: 3
            },
            {
                question: "For a Digital Twin to provide real-time operational insights in manufacturing, which combination is most essential?",
                options: ["Cloud storage and APIs", "Mobile apps and dashboards", "IoT sensors and ML", "Blockchain and encryption", "GPS tracking and mapping", "Social media and analytics"],
                correct: [2],
                difficulty: "simple",
                points: 3
            },
            {
                question: "What is the primary difference between Generative AI and traditional AI in business applications?",
                options: ["Processing speed capabilities", "Content creation ability", "Data storage requirements", "Implementation complexity", "Hardware specifications", "Security protocols"],
                correct: [1],
                difficulty: "simple",
                points: 3
            }
        ];

        const round2Questions = [
            {
                scenario: "An ML churn model's accuracy plummets after merging data from an acquired company, as it now misidentifies loyal clients.",
                question: "What is the most likely technical cause for this failure?",
                options: ["Concept drift from the new, distinct customer behaviors", "A recent update to the model's core algorithm", "Data latency issues from the new cloud environment", "Insufficient computing power for the larger dataset"],
                correct: [0],
                difficulty: "scenario",
                points: 5
            },
            {
                scenario: "A retailer's delivery AI can optimize for either speed or cost. With the primary company goal of improving profit margins, what is the best success metric?",
                question: "What is the most critical success metric for this AI initiative?",
                options: ["Reduction in average delivery time", "Decrease in total cost-per-package delivered", "Reduction in daily route planning time", "Achieving a 5-point lift in customer satisfaction (CSAT)"],
                correct: [1],
                difficulty: "scenario",
                points: 5
            },
            {
                scenario: "A stable, 95% accurate ML model for predicting equipment failure suddenly starts missing critical alerts. The model's code is unchanged.",
                question: "What is the most probable cause of this sudden degradation in performance?",
                options: ["The model has become overfitted to historical data", "A failure in the nightly data-refresh (ETL) process", "A key upstream data sensor is failing or miscalibrated", "The algorithm requires a theoretical update from R&D"],
                correct: [2],
                difficulty: "scenario",
                points: 5
            },
            {
                scenario: "A GenAI agent for HR questions is fluent but sometimes provides confident yet incorrect answers on nuanced company policies.",
                question: "Which technical approach offers the most robust solution?",
                options: ["Switching to the latest, most powerful base model available", "Increasing the number of agents to handle more queries", "Implementing a Retrieval-Augmented Generation (RAG) architecture", "Retraining the model weekly on a larger public dataset"],
                correct: [2],
                difficulty: "scenario",
                points: 5
            },
            {
                scenario: "When choosing a first Agentic AI project, you must decide between automating the high-risk client onboarding process or the low-risk internal expense reporting.",
                question: "What is the most prudent strategic first step?",
                options: ["Pursue the high-risk client process to maximize early impact", "Automate the low-risk internal process to build capability first", "Outsource both projects to a specialist AI vendor", "Benchmark both options with a consulting firm for a quarter"],
                correct: [1],
                difficulty: "scenario",
                points: 5
            },
            {
                scenario: "An AI inspects products on a production line. An error where it wrongly flags a good product costs $10 to re-check. An error where it misses a real defect costs the company $5,000 in recalls.",
                question: "Given the high cost of missing a defect, what should the AI's primary goal be?",
                options: ["Flag only definite defects to minimize re-inspection costs.", "Catch every possible defect, even if some good products are re-inspected.", "Treat both types of errors as equally important to the business.", "Optimize for the fastest possible inspection speed."],
                correct: [1],
                difficulty: "scenario",
                points: 5
            },
            {
                scenario: "To improve a B2B SaaS company's AI sales forecast, the team needs to add the most powerful leading indicator of future revenue.",
                question: "Which data source would provide the most predictive lift?",
                options: ["Aggregate customer feature usage and engagement data", "National unemployment and inflation figures", "Marketing campaign spend and attribution data", "The company's social media follower growth rate"],
                correct: [0],
                difficulty: "scenario",
                points: 5
            },
            {
                scenario: "An airline's predictive AI is 99% accurate on common faults but fails to predict a rare, critical failure not seen in its training data.",
                question: "This failure highlights which fundamental limitation of ML?",
                options: ["The system lacks sufficient real-time sensor data", "The human technicians are not trusting the AI's outputs", "The algorithm's processing speed is inadequate for aviation", "The training data underrepresents \"black swan\" events"],
                correct: [3],
                difficulty: "scenario",
                points: 5
            },
            {
                scenario: "A consulting firm's GenAI produces flawless grammar but lacks the company's unique analytical style and voice.",
                question: "What is the most direct way to infuse the AI with the firm's unique voice?",
                options: ["Engineering more complex, multi-shot prompts", "Implementing a stricter content and brand safety filter", "Switching to a larger, more generalist foundation model", "Fine-tuning the model on the firm's archive of past reports"],
                correct: [3],
                difficulty: "scenario",
                points: 5
            },
            {
                scenario: "The CDIO wants to deploy GenAI agents across Finance, HR, and Sales. The goal is to provide consistent, accurate answers, but each department's data is currently siloed and of varying quality.",
                question: "To ensure these agents are reliable, what is the most critical foundational step?",
                options: ["Establish a robust, cross-functional AI governance board.", "Select a single, powerful LLM for all agents to ensure consistency.", "Create a data catalog defining authoritative data sources for the AI.", "Immediately hire prompt engineers for each department."],
                correct: [2],
                difficulty: "scenario",
                points: 5
            }
        ];

        const promptTasks = [
            {
                title: "Production Report Generation",
                brokenPrompt: "Make me a report for production stuff",
                description: "Write a clear prompt to generate a comprehensive daily production report for cement plant managers"
            },
            {
                title: "Customer Service AI Assistant",
                brokenPrompt: "Help customer with problems",
                description: "Write a clear prompt for an AI assistant to handle customer service inquiries professionally"
            }
        ];

        // Initialize
        window.onload = function() {
            initializeFirebase();
        };

        async function initializeFirebase() {
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Test Firebase connection
                await db.collection('gameState').doc('current').get();
                updateConnectionStatus(true);
                
                // Get team from URL and initialize
                getTeamFromURL();
                await initializeTeam();
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus(false);
                showError('Firebase connection failed. Please check your internet connection and try again.');
            }
        }

        function getTeamFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            teamId = urlParams.get('team');
            
            if (!teamId || teamId < 1 || teamId > 10) {
                showError('Invalid team ID! Please use a valid team link.');
                return;
            }
            
            const team = teamData[teamId];
            if (!team) {
                showError('Team not found! Please use a valid team link.');
                return;
            }
            
            document.getElementById('teamInfo').textContent = `${team.name} - ${team.fullName}`;
        }

        async function initializeTeam() {
            if (!teamId || !db) return;

            try {
                // Lock the session for this team
                const team = teamData[teamId];
                await db.collection('teams').doc(teamId).set({
                    name: team.name,
                    fullName: team.fullName,
                    sessionLocked: true,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Start listening for game state changes, which will drive the UI
                listenForGameState();

            } catch (error) {
                console.error('Error initializing team:', error);
                updateConnectionStatus(false);
                showError('Failed to initialize team session. Please try again.');
            }
        }

        async function loadCurrentState() {
            try {
                const teamDoc = await db.collection('teams').doc(teamId).get();
                if (teamDoc.exists) {
                    const teamData = teamDoc.data();
                    const savedState = teamData.currentState;
                    
                    if (savedState) {
                        currentRound = savedState.currentRound || 0;
                        currentQuestionIndex = savedState.currentQuestionIndex || 0;
                        currentScore = savedState.currentScore || 0;
                        currentPromptTask = savedState.currentPromptTask || 0;
                        
                        console.log('Restored state:', savedState);
                    }
                }
            } catch (error) {
                console.error('Error loading current state:', error);
            }
        }

        async function saveCurrentState() {
            if (!db || !teamId) return;
            
            try {
                const stateToSave = {
                    currentRound,
                    currentQuestionIndex,
                    currentScore,
                    currentPromptTask,
                    lastSaved: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('teams').doc(teamId).update({
                    currentState: stateToSave,
                    [`rounds.round${currentRound}.liveScore`]: currentScore,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('State saved:', stateToSave);
                
            } catch (error) {
                console.error('Error saving current state:', error);
            }
        }

        function listenForGameState() {
            if (!db) return;

            gameStateListener = db.collection('gameState').doc('current').onSnapshot(async (doc) => {
                if (!doc.exists) {
                    console.log("No game state found. Waiting for admin.");
                    displayWaitingScreen("Waiting for admin to start the game...");
                    return;
                }

                const gameData = doc.data();
                const newRound = gameData.currentRound || 0;
                const wasActive = roundActive;

                // Update state based on Firebase data
                const isRoundNumberActive = newRound >= 1 && newRound <= 3;
                const isTimerValid = gameData.roundEndTime && (gameData.roundEndTime.toDate() > new Date());

                currentRound = newRound;
                roundActive = isRoundNumberActive && isTimerValid;

                // If the round has just become active, load state and start the timer
                if (roundActive && !wasActive) {
                    console.log(`Round ${currentRound} is now active.`);
                    await loadCurrentState(); // Load any saved progress
                    roundEndTime = gameData.roundEndTime.toDate();
                    timeLeft = Math.max(0, Math.floor((roundEndTime - new Date()) / 1000));
                    startTimer();
                } else if (!roundActive && wasActive) {
                    console.log(`Round ${currentRound} is no longer active.`);
                    clearInterval(timer);
                }
                
                // Always update the display to reflect the latest state from Firebase
                updateGameDisplay();

            }, (error) => {
                console.error('Error listening to game state:', error);
                updateConnectionStatus(false);
            });
        }


        function displayFirstQuestion() {
            // Show Round 1 Question 1 but keep currentRound = 0 until admin starts
            currentQuestionIndex = 0;
            currentScore = 0;
            roundActive = false;
            displayRound1Question();
        }

        function updateGameDisplay() {
            // This function now purely renders the UI based on the current state variables
            if (currentRound === 0) {
                displayFirstQuestion();
            } else if (currentRound === 1) {
                displayRound1Question();
            } else if (currentRound === 2) {
                displayRound2Question();
            } else if (currentRound === 3) {
                displayPromptTask();
            } else if (currentRound >= 11 && currentRound <= 13) {
                // Admin has ended the round
                handleRoundEnd();
            } else {
                 // Default waiting screen if state is unusual
                displayWaitingScreen("Synchronizing with game server...");
            }
        }

        function displayRound1Question() {
            if (currentQuestionIndex >= round1Questions.length) {
                completeRound1();
                return;
            }

            const question = round1Questions[currentQuestionIndex];
            const container = document.getElementById('quizContainer');
            
            const isWaiting = (currentRound === 0 || !roundActive);
            
            const optionsHTML = question.options.map((option, index) => 
                `<button class="option-btn ${isWaiting ? 'disabled' : ''}" onclick="selectAnswer(${index}, 1)" ${isWaiting ? 'disabled' : ''}>${option}</button>`
            ).join('');

            const waitingMessage = isWaiting ? `
                <div class="waiting-for-timer">
                    ‚è≥ <strong>Waiting for admin to start Round 1 timer...</strong><br>
                    You can see the questions but cannot answer until the timer starts!
                </div>
            ` : '';

            container.innerHTML = `
                <div class="round-indicator">üß† Round 1: Fundamentals (${currentQuestionIndex + 1}/10)</div>
                ${waitingMessage}
                <div class="quiz-header">
                    <div class="question-info">
                        <div class="question-counter">Question ${currentQuestionIndex + 1} of 10</div>
                        <div class="score-display">Score: ${currentScore} points</div>
                    </div>
                    <div class="timer-display ${isWaiting ? 'stopped' : ''}" id="timerDisplay">
                        ${isWaiting ? 'Waiting...' : formatTime(timeLeft)}
                    </div>
                </div>
                <div class="question-card fade-in">
                    <div class="question-difficulty difficulty-${question.difficulty}">
                        ${question.difficulty.toUpperCase()} - ${question.points} points
                    </div>
                    <div class="question-text">${question.question}</div>
                    <div class="options-grid">
                        ${optionsHTML}
                    </div>
                </div>
            `;
            
            if (!isWaiting) {
                updateTimerDisplay();
            }
        }

        function displayRound2Question() {
            if (currentQuestionIndex >= round2Questions.length) {
                completeRound2();
                return;
            }

            const question = round2Questions[currentQuestionIndex];
            const container = document.getElementById('quizContainer');
            
            const optionsHTML = question.options.map((option, index) => 
                `<button class="option-btn" onclick="selectAnswer(${index}, 2)">${option}</button>`
            ).join('');

            container.innerHTML = `
                <div class="round-indicator">üéØ Round 2: Scenarios (${currentQuestionIndex + 1}/10)</div>
                <div class="quiz-header">
                    <div class="question-info">
                        <div class="question-counter">Question ${currentQuestionIndex + 1} of 10</div>
                        <div class="score-display">Score: ${currentScore} points</div>
                    </div>
                    <div class="timer-display" id="timerDisplay">${formatTime(timeLeft)}</div>
                </div>
                <div class="question-card fade-in">
                    <div class="question-difficulty difficulty-${question.difficulty}">
                        SCENARIO - ${question.points} points
                    </div>
                    <div class="scenario-text">
                        <strong>${question.scenario}:</strong> ${question.question}
                    </div>
                    <div class="options-grid">
                        ${optionsHTML}
                    </div>
                </div>
            `;
        }

        function displayPromptTask() {
            if (currentPromptTask >= promptTasks.length) {
                completeRound3();
                return;
            }

            const task = promptTasks[currentPromptTask];
            const container = document.getElementById('quizContainer');

            container.innerHTML = `
                <div class="round-indicator">‚úèÔ∏è Round 3: Prompt Engineering (${currentPromptTask + 1}/2)</div>
                <div class="quiz-header">
                    <div class="question-info">
                        <div class="question-counter">Task ${currentPromptTask + 1} of 2</div>
                        <div class="score-display">Manual Scoring by Admin</div>
                    </div>
                    <div class="timer-display" id="timerDisplay">${formatTime(timeLeft)}</div>
                </div>
                <div class="question-card fade-in">
                    <div class="question-difficulty" style="background: #9b59b6;">
                        PROMPT TASK
                    </div>
                    <div class="question-text">
                        <strong>${task.title}</strong><br>
                        ${task.description}
                    </div>
                    <div style="margin: 20px 0;">
                        <strong>‚ùå Broken Prompt:</strong>
                        <div style="background: rgba(231,76,60,0.2); padding: 15px; border-radius: 8px; margin: 10px 0; font-style: italic; border-left: 4px solid #e74c3c;">
                            "${task.brokenPrompt}"
                        </div>
                    </div>
                    <strong>‚úÖ Write a Better Prompt:</strong>
                    <textarea class="prompt-input" id="promptInput" placeholder="Write your improved prompt here..."></textarea>
                    <button class="submit-prompt-btn" onclick="submitPrompt()" ${!roundActive ? 'disabled' : ''}>Submit Prompt</button>
                </div>
            `;
        }

        function selectAnswer(selectedIndex, round) {
            if (!roundActive) {
                alert('Please wait for the admin to start the round timer!');
                return;
            }
            
            const questions = round === 1 ? round1Questions : round2Questions;
            const question = questions[currentQuestionIndex];
            const options = document.querySelectorAll('.option-btn');
            const questionCard = document.querySelector('.question-card');
            
            // Disable all options immediately
            options.forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.disabled = true;
            });
            
            const isCorrect = question.correct.includes(selectedIndex);
            const selectedOption = options[selectedIndex];
            
            if (isCorrect) {
                selectedOption.classList.add('correct');
                currentScore += question.points;
                updateScore();
            } else {
                selectedOption.classList.add('wrong');
            }
            
            // Save state after answering
            saveCurrentState();
            
            // Fade out and advance after 500ms
            setTimeout(() => {
                // Add fade out effect
                questionCard.classList.add('fade-out');
                
                setTimeout(() => {
                    currentQuestionIndex++;
                    saveCurrentState(); // Save updated question index
                    
                    // Display next question with fade in
                    if (round === 1) {
                        displayRound1Question();
                    } else if (round === 2) {
                        displayRound2Question();
                    }
                }, 300); // Fade out duration
            }, 500); // Answer feedback duration
        }

        async function submitPrompt() {
            if (!roundActive) {
                alert('Please wait for the admin to start Round 3!');
                return;
            }
            
            const promptText = document.getElementById('promptInput').value.trim();
            if (!promptText) {
                alert('Please write a prompt before submitting!');
                return;
            }

            try {
                const submitBtn = document.querySelector('.submit-prompt-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                
                // Save prompt to database
                await db.collection('prompts').doc(teamId).collection('round3').doc(`task${currentPromptTask + 1}`).set({
                    taskTitle: promptTasks[currentPromptTask].title,
                    brokenPrompt: promptTasks[currentPromptTask].brokenPrompt,
                    improvedPrompt: promptText,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    teamName: teamData[teamId].name
                });

                currentPromptTask++;
                saveCurrentState(); // Save updated task index
                
                // Fade transition
                const questionCard = document.querySelector('.question-card');
                questionCard.classList.add('fade-out');
                
                setTimeout(() => {
                    displayPromptTask();
                }, 300);
                
            } catch (error) {
                console.error('Error submitting prompt:', error);
                alert('Error submitting prompt. Please try again.');
                const submitBtn = document.querySelector('.submit-prompt-btn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Prompt';
            }
        }

        async function completeRound1() {
            try {
                await db.collection('teams').doc(teamId).update({
                    'rounds.round1.score': currentScore,
                    'rounds.round1.completed': true,
                    'rounds.round1.completedAt': firebase.firestore.FieldValue.serverTimestamp(),
                    currentState: firebase.firestore.FieldValue.delete() // Clear saved state
                });
                
                showRoundComplete(1, currentScore);
            } catch (error) {
                console.error('Error completing round 1:', error);
            }
        }

        async function completeRound2() {
            try {
                await db.collection('teams').doc(teamId).update({
                    'rounds.round2.score': currentScore,
                    'rounds.round2.completed': true,
                    'rounds.round2.completedAt': firebase.firestore.FieldValue.serverTimestamp(),
                    currentState: firebase.firestore.FieldValue.delete() // Clear saved state
                });
                
                showRoundComplete(2, currentScore);
            } catch (error) {
                console.error('Error completing round 2:', error);
            }
        }

        async function completeRound3() {
            try {
                await db.collection('teams').doc(teamId).update({
                    'rounds.round3.completed': true,
                    'rounds.round3.completedAt': firebase.firestore.FieldValue.serverTimestamp(),
                    currentState: firebase.firestore.FieldValue.delete() // Clear saved state
                });
                
                showRoundComplete(3, 'Submitted');
            } catch (error) {
                console.error('Error completing round 3:', error);
            }
        }

        function showRoundComplete(round, score) {
            roundActive = false;
            clearInterval(timer);
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="completion-screen">
                    <h2>üéâ Round ${round} Complete! üéâ</h2>
                    <div class="final-score">${score}${typeof score === 'number' ? ' points' : ''}</div>
                    <p>Great job, ${teamData[teamId].name}!</p>
                    <p>Waiting for the next round to begin...</p>
                </div>
            `;
        }

        function handleRoundEnd() {
            roundActive = false;
            clearInterval(timer);
            
            // Clear saved state when round ends
            if (db && teamId) {
                db.collection('teams').doc(teamId).update({
                    currentState: firebase.firestore.FieldValue.delete()
                }).catch(error => console.error('Error clearing state on round end:', error));
            }
            
            if (currentRound === 11) { // Round 1 ended
                completeRound1();
            } else if (currentRound === 12) { // Round 2 ended
                completeRound2();
            } else if (currentRound === 13) { // Round 3 ended
                completeRound3();
            }
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                if (roundEndTime) {
                    const now = new Date();
                    timeLeft = Math.max(0, Math.floor((roundEndTime - now) / 1000));
                } else {
                    // Fallback if end time is not set, though it should be.
                    timeLeft = Math.max(0, timeLeft - 1);
                }

                updateTimerDisplay();

                const display = document.getElementById('timerDisplay');
                if (display) {
                    if (timeLeft <= 60 && timeLeft > 0) {
                        display.classList.add('warning');
                    } else {
                        display.classList.remove('warning');
                    }
                }

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    if (roundActive) {
                        handleTimeUp();
                    }
                }
            }, 1000);
        }

        function handleTimeUp() {
            if (currentRound === 1) {
                completeRound1();
            } else if (currentRound === 2) {
                completeRound2();
            } else if (currentRound === 3) {
                completeRound3();
            }
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            if (display && roundActive) {
                display.textContent = formatTime(timeLeft);
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateScore() {
            const scoreDisplay = document.querySelector('.score-display');
            if (scoreDisplay) {
                scoreDisplay.textContent = `Score: ${currentScore} points`;
                scoreDisplay.classList.add('updated');
                setTimeout(() => {
                    scoreDisplay.classList.remove('updated');
                }, 300);
            }
        }

        function showSessionExpired() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="session-expired">
                    <h2>üîí Session Locked</h2>
                    <p>This team link is currently being used by another team member.</p>
                    <p>Please wait for them to finish or contact your team captain.</p>
                    <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
                        Sessions automatically unlock after 1 hour of inactivity.
                    </p>
                </div>
            `;
        }

        function showError(message) {
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="session-expired">
                    <h2>‚ùå Error</h2>
                    <p>${message}</p>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Retry
                    </button>
                </div>
            `;
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = '‚úÖ Connected';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = '‚ùå Connection Error';
                statusElement.className = 'connection-status disconnected';
            }
        }

        function displayWaitingScreen(message) {
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="waiting-screen">
                    <h2>${message}</h2>
                    <p>Please wait, the quiz will begin shortly.</p>
                </div>
            `;
        }

        // Add debugging function
        function showDebugInfo() {
            const debugInfo = {
                teamId,
                currentRound,
                roundActive,
                timeLeft,
                currentQuestionIndex,
                currentScore,
                connectionStatus: document.getElementById('connectionStatus').textContent
            };
            
            console.log('Debug Info:', debugInfo);
            return debugInfo;
        }

        // Expose debug function globally
        window.showDebugInfo = showDebugInfo;
    </script>
</body>
</html>
